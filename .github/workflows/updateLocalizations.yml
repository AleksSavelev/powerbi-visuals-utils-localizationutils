on: push

jobs:
  update_translations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          persist-credentials: false
          token: ${{ secrets.TOKEN }}
      - name: Set config details
        run: |
          git config --global user.name 'pbcvloc'
          git config --global user.email 'pbcvloc@microsoft.com'
          git config core.ignorecase true
      - name: Update submodules
        run: |
          mainFolder=$PWD
          git remote remove origin
          git remote add origin "https://pbcvloc:${{secrets.TOKEN}}@github.com/Alekssavelev/powerbi-visuals-utils-localizationutils.git"
          for folder in visuals/*; do
            repoName=$(echo $folder| cut -d'/' -f 2)
            cd "$mainFolder/$folder"
            git remote remove origin
            git remote add origin https://pbcvloc:${{secrets.TOKEN}}@github.com/microsoft/$repoName.git
            # defaultBranchName=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
            # git checkout $defaultBranchName >/dev/null && git pull >/dev/null
            # echo "$folder updated"
            # git checkout new-translations 2>/dev/null && git pull && git rebase $defaultBranchName|| git checkout -b new-translations
          done;
          git pull --recurse-submodules
          git submodule update --remote --recursive
          cd $mainFolder
          git add . && git commit -m "New translation" >/dev/null && git push || echo "No submodule updates"
      - name: Copy EN translation
        run: |
          for file in ./visuals/*/stringResources/en-US/resources.resjson; do 
            substring="visuals/"
            location="${file/$substring/localizations/}"
            substring="/stringresources"
            newLocation="${location/$substring//stringResources}"
            cp $file $newLocation;
          done;
      - name: Commit and push EN translation
        run:
          git add . && git commit -m "New translation" >/dev/null && git push || echo "No changes to commit"
      - name: Copy translations
        run: |
          for file in ./visuals/*/stringResources/*/resources.resjson; do 
            substring="visuals/"
            location="${file/$substring/localizations/}"
            substring="/stringresources"
            oldFile="${location/$substring//stringResources}"
            cp $oldFile $file;
          done;
      - name: Commit and push new changes to repos
        run: |
          mainFolder=$PWD
          for folder in visuals/*; do
            repoName=$(echo $folder| cut -d'/' -f 2)
            cd "$mainFolder/$folder"
            defaultBranchName=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
            git add . && git commit -m "New translations" >/dev/null && \
              (git push origin new-translations || git push --set-upstream origin new-translations) &&
              curl \
                -X POST \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/microsoft/$repoName/pulls \
                -d '{"title":"New translations","head":"microsoft:new-translations","base":"$defaultBranchName"}' || \
              echo "No changes for $repoName"
          done;